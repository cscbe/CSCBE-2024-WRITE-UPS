FROM ubuntu:16.04

RUN sed -i 's/archive.ubuntu.com/asia-east1.gce.archive.ubuntu.com/g' /etc/apt/sources.list && apt update && apt-get install -y lib32z1 xinetd socat && rm -rf /var/lib/apt/lists/ && rm -rf /root/.cache && apt-get autoclean && rm -rf /tmp/* /var/lib/apt/* /var/cache/* /var/log/*
#apt update && apt-get install -y lib32z1 xinetd && rm -rf /var/lib/apt/lists/ && rm -rf /root/.cache && apt-get autoclean && rm -rf /tmp/* /var/lib/apt/* /var/cache/* /var/log/*
RUN apt-get update && apt-get install -y build-essential

COPY ./pwn.xinetd /etc/xinetd.d/pwn

COPY ./service.sh /service.sh

RUN chmod +x /service.sh

EXPOSE 1337

# useradd and put flag
RUN useradd -m bookstore && echo 'CSC{H1pped3y_h0pp3dey_y0ur_stor3_is_n0w_my_prOp3rty!}' > /home/bookstore/flag.txt

# copy bin
COPY ./bin/bookstore.c /home/bookstore/bookstore.c
RUN gcc -o /home/bookstore/bookstore /home/bookstore/bookstore.c -fno-stack-protector -D_BSD_SOURCE

# chown & chmod
RUN chown -R root:bookstore /home/bookstore && chmod -R 750 /home/bookstore && chmod 740 /home/bookstore/flag.txt

# copy lib,/bin 
RUN cp -R lib* /home/bookstore && cp -R usr/lib* /home/bookstore && mkdir /home/bookstore/bin/ && cp /bin/sh /home/bookstore/bin && cp /bin/ls /home/bookstore/bin/ && cp /bin/cat /home/bookstore/bin/

CMD ["/service.sh"]
