#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <signal.h>

#define MAX 10
#define TIMEOUT_SECONDS 20

struct H {
	char* m[MAX];
	unsigned size[MAX];
};

struct H ptr;

int drain_char() {
	int readchar = getchar();
	if(readchar == -1) {
		exit(1);
	}
	return readchar;
}

int flush_stdin() {
    while (drain_char() != '\n');
    return 1;
}

void sigpipe_handler(int signum) {
    exit(signum);
}

void menu() {
	puts("Welcome back to the management platform of your online bookstore!");
	puts("What do you want to do?");
	puts("1 - Add new book");
	puts("2 - Change description");
	puts("3 - View description");
	puts("4 - Remove a book");
	puts("5 - Exit");
}


void new_book() {
	unsigned pos = 0;
	char c;
	puts("Where do you want to place this book on your website? You have 10 slots available. [0-10]");
	while ((scanf("%u%c", &pos, &c) != 2 || c != '\n') && flush_stdin());
	if (pos < MAX) {
		puts("Enter size for the product description. [# characters]");
		while ((scanf("%u%c", &ptr.size[pos], &c) != 2 || c != '\n') && flush_stdin());
		if (ptr.size[pos] >= 0 && ptr.size[pos] < 0x80) {
			ptr.m[pos] = malloc(ptr.size[pos]);
		} else {
			puts("Too large description. Won't fit on the webpage.");
		}
	} else {
		puts("Can't sell more than 10 books.");
	}
}

void change_description() {
	unsigned i = 0;
	char c;
	puts("Enter index of book for which you want to change the product description. [0-10]");
	while ((scanf("%u%c", &i, &c) != 2 || c != '\n') && flush_stdin());
	if (i < MAX) {
		puts("Enter product description");
		read(0, ptr.m[i], ptr.size[i]);
	} else {
		puts("Can't sell more than 10 books.");	
	}
}

void view_description() {
	unsigned i = 0;
	char c;
	puts("Enter the index of the book for which you want to see the product description. [0-10]");
	while ((scanf("%u%c", &i, &c) != 2 || c != '\n') && flush_stdin());
	if (i < MAX) {
		write(1, ptr.m[i], ptr.size[i]);
	} else {
		puts("Can't sell more than 10 books.");
	}	
}

void remove_book() {
	unsigned i = 0;
	char c;
	puts("Enter the index of the book you want to remove from the store. [0-10]");
	while ((scanf("%u%c", &i, &c) != 2 || c != '\n') && flush_stdin());
	if (i < MAX) {
		free(ptr.m[i]);
	} else {
		puts("Can't sell more than 10 books.");
	}
}	

int main(void) {
	int i = 0;
	char c;
	
	signal(SIGINT, sigpipe_handler);
	signal(SIGALRM, sigpipe_handler);
	signal(SIGPIPE, sigpipe_handler);
	
	setvbuf(stdin, 0, 2, 0);
  	setvbuf(stdout, 0, 2, 0);
	
	//alarm(TIMEOUT_SECONDS);

	do {
      		menu();
    		while ((scanf("%u%c", &i, &c) != 2 || c != '\n') && flush_stdin());
    		switch (i) {
	    		case 1: new_book(); 
	    		break;
			case 2: change_description(); 
			break;
			case 3: view_description(); 
			break;
			case 4: remove_book(); 
			break;
			case 5: printf("Have an amazing day!\n"); 
			return 0;
    		}
    		
			alarm(TIMEOUT_SECONDS);
			
	} while (1);
}
