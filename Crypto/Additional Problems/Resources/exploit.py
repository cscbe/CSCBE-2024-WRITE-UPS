from pwn import *
import sympy.ntheory.modular

p = remote('0.0.0.0', 1340)

encrypted_flag = []
p.recvuntil(b'secret flag with it:\n')
while True:
    line = p.recvline()
    if line.decode().strip():
        encrypted_flag.append(line)
    else:
        break

mods = {}
for N in range(128, 160):
    p.recvuntil(b'Choose N: ')
    print(end=f"Starting {N}  ")
    p.sendline(str(N).encode())

    while True:
        print(end='.')
        p.recvuntil(b'l): ')
        p.sendline(b'00')
        p.recvuntil(b'> ')
        p.sendline(b'3')
        p.recvuntil(b'Decrypted message: ')
        d = p.recv(2)
        if d != b'00': break
        p.recvuntil(b'> ')
        p.sendline(b'2')

    mods[N] = N - int(d, 16)
    print(mods[N])
    p.recvuntil(b'> ')
    p.sendline(b'1')

p = sympy.ntheory.modular.crt(mods.keys(), mods.values())[0]
print(p)
flag = ''.join([chr((int(c.decode()) % p) % 2**7) for c in encrypted_flag])
print(flag)
